#!/bin/bash
# kubctl-0x01: Scale Django app deployment and verify performance

set -e

DEPLOYMENT_NAME="messaging-app-deployment"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"

echo "üöÄ Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "‚úÖ Verifying pods..."
kubectl get pods -n $NAMESPACE -o wide

echo "üìã Checking resource usage..."
kubectl top pods -n $NAMESPACE || echo "‚ö†Ô∏è Metrics server not installed. Install with: minikube addons enable metrics-server"

# Get ClusterIP of the service
CLUSTER_IP=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.clusterIP}')
PORT=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].port}')

echo "üåê Running load test with wrk against http://$CLUSTER_IP:$PORT ..."
wrk -t4 -c100 -d30s http://$CLUSTER_IP:$PORT || echo "‚ö†Ô∏è wrk must be installed locally to run load test"

echo "üéØ Scaling and load testing complete!"
